# OnTerapi v4 - Sistema de Gest√£o para Terapias Integrativas

## üìã √çndice
- [Sobre](#sobre)
- [Arquitetura](#arquitetura)
- [Instala√ß√£o](#instala√ß√£o)
- [Configura√ß√£o](#configura√ß√£o)
- [Desenvolvimento](#desenvolvimento)
- [M√≥dulos](#m√≥dulos)
- [API](#api)
- [Testes](#testes)
- [Deploy](#deploy)

## üìå Sobre

OnTerapi v4 √© uma plataforma SaaS multi-tenant completa para gest√£o de cl√≠nicas e profissionais de terapias integrativas, com sistema de IA multi-agentes especializado.

### Principais Funcionalidades
- üè• Gest√£o completa de cl√≠nicas e profissionais
- üìÖ Sistema de agendamento inteligente
- üìã Anamnese digital com 10 etapas estruturadas
- üíä Planos terap√™uticos com IA (23 agentes especializados)
- üí∞ M√≥dulo financeiro com split autom√°tico
- ü§ñ Sistema CrewAI integrado
- üì± Portais dedicados (profissional, paciente, admin)
- üõí Marketplace p√∫blico
- ‚úÖ Sistema de verifica√ß√£o de email com tokens seguros
- üîê Autentica√ß√£o 100% Supabase Cloud
- üìß Alertas de login com IP e localiza√ß√£o

## üß™ Usu√°rios de Teste

### Tabela de Usu√°rios Criados

| Email | Senha | Role | CPF | Status | Observa√ß√µes |
|-------|-------|------|-----|--------|-------------|
| lina73@ethereal.email | Admin@123456 | SUPER_ADMIN | - | ‚úÖ Ativo | Super administrador principal |
| patient@onterapi.com | Patient@123 | PATIENT | - | ‚úÖ Ativo | Paciente de teste |
| professional@onterapi.com | Prof@123456 | PROFESSIONAL | - | ‚úÖ Ativo | Profissional de sa√∫de |
| owner@onterapi.com | Owner@123456 | CLINIC_OWNER | - | ‚úÖ Ativo | Dono de cl√≠nica |
| secretary@onterapi.com | Secretary@123 | SECRETARY | - | ‚úÖ Ativo | Secret√°ria |
| admin.fin@onterapi.com | AdminFin@123 | ADMIN_FINANCEIRO | - | ‚úÖ Ativo | Admin financeiro |
| admin.support@onterapi.com | Support@123 | ADMIN_SUPORTE | - | ‚úÖ Ativo | Admin suporte |
| manager@onterapi.com | Manager@123 | MANAGER | - | ‚úÖ Ativo | Gerente |
| test_verification@ethereal.email | Test@123456 | PATIENT | 76567840552 | ‚úÖ Verificado | Teste de verifica√ß√£o email |

### Como Testar

1. **Login**: Use o endpoint `/auth/sign-in` com email e senha
2. **Verifica√ß√£o de Email**: Novos usu√°rios recebem link de verifica√ß√£o que expira em 24h
3. **Refresh Token**: Use `/auth/refresh` com o refreshToken
4. **Logout**: Use `/auth/sign-out` com Bearer token
5. **Me**: Use `/auth/me` para obter dados do usu√°rio autenticado

## üèóÔ∏è Arquitetura

### Stack Tecnol√≥gica
- **Backend**: NestJS 10.3 + TypeScript 5.3
- **Database**: Supabase Cloud (PostgreSQL) - **SEM BANCO LOCAL**
- **ORM**: TypeORM 0.3 (apenas para estrutura, dados no Supabase)
- **Cache**: Redis 7
- **Queue**: Bull
- **Mensageria**: EventEmitter + RabbitMQ
- **Valida√ß√£o**: Zod 3.22
- **Auth**: Supabase Auth + JWT (100% cloud)
- **Email**: Nodemailer + Ethereal (dev) / SMTP (prod)
- **Docs**: Swagger + Compodoc
- **AI**: OpenAI + CrewAI

### Padr√µes Arquiteturais
- **DDD** (Domain-Driven Design)
- **Clean Architecture**
- **CQRS Pattern**
- **Event-Driven Architecture**
- **Repository Pattern**
- **Result Pattern**

### Estrutura de M√≥dulos
```
src/
‚îú‚îÄ‚îÄ domain/           # L√≥gica de neg√≥cio pura
‚îú‚îÄ‚îÄ infrastructure/   # Implementa√ß√µes t√©cnicas
‚îú‚îÄ‚îÄ modules/          # M√≥dulos da aplica√ß√£o
‚îú‚îÄ‚îÄ shared/           # C√≥digo compartilhado
‚îî‚îÄ‚îÄ core/            # Configura√ß√µes globais
```

## üöÄ Instala√ß√£o

### Pr√©-requisitos
- Node.js >= 20.0.0
- Docker >= 24.0.0 (opcional)
- Docker Compose >= 2.20.0 (opcional)
- PostgreSQL >= 16 (se n√£o usar Docker)
- Redis >= 7 (se n√£o usar Docker)
- npm >= 10.0.0

### Setup Inicial

#### Op√ß√£o 1: Instala√ß√£o Local
```bash
# Clonar reposit√≥rio
git clone https://github.com/onterapi/v4.git
cd onterapi-v4

# Instalar depend√™ncias
npm install

# Configurar vari√°veis de ambiente
cp .env.example .env

# Rodar migrations
npm run migration:run

# Rodar seeds (dados iniciais)
npm run seed:run

# Iniciar desenvolvimento (porta 3001)
npm run dev
```

#### Op√ß√£o 2: Usando Docker
```bash
# Clonar reposit√≥rio
git clone https://github.com/onterapi/v4.git
cd onterapi-v4

# Build da imagem Docker
docker build -t onterapi-v4:latest .

# Iniciar com Docker Compose
docker compose up -d

# Aplica√ß√£o estar√° dispon√≠vel em http://localhost:3001
# Swagger em http://localhost:3001/api
```

### Scripts de Automa√ß√£o

#### Windows (PowerShell)
```powershell
# Iniciar desenvolvimento
.\docker-run.ps1 dev

# Parar containers
.\docker-run.ps1 stop

# Limpar tudo
.\docker-run.ps1 clean
```

#### Linux/Mac (Bash)
```bash
# Iniciar desenvolvimento
./docker-run.sh dev

# Parar containers
./docker-run.sh stop

# Limpar tudo
./docker-run.sh clean
```

## ‚öôÔ∏è Configura√ß√£o

### üóÑÔ∏è Banco de Dados - Supabase Cloud Only

**‚ö†Ô∏è IMPORTANTE: Este projeto N√ÉO usa banco de dados local. Todos os dados est√£o no Supabase Cloud.**

#### Configura√ß√£o para Docker (Recomendado)
```env
# Use IP direto do pooler para evitar problemas de DNS no Docker
DB_HOST=54.94.90.106
DB_PORT=6543
DB_USERNAME=postgres.ogffdaemylaezxpunmop
DB_PASSWORD=5lGR6N9OyfF1fcMc
DB_DATABASE=postgres
DB_SSL=true

# Supabase Configuration
SUPABASE_URL=https://ogffdaemylaezxpunmop.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
DB_DATABASE=postgres
DB_SSL=true
DB_SCHEMA=public
```

#### APIs Supabase
```env
# URLs e Chaves
SUPABASE_URL=https://ogffdaemylaezxpunmop.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_PROJECT_ID=ydctcvehdabvoyjunzrk
```

#### Outras Configura√ß√µes
```env
# JWT
JWT_SECRET=your_jwt_secret_min_32_chars
JWT_EXPIRES_IN=7d

# OpenAI (para CrewAI)
OPENAI_API_KEY=sk-proj-...

# API
PORT=3000
NODE_ENV=development
```

### ‚ö†Ô∏è Seguran√ßa Supabase
- **Service Key**: NUNCA expor no frontend, apenas backend
- **Anon Key**: Pode ser usada no frontend com RLS habilitado
- **RLS**: Sempre habilitar Row Level Security em todas as tabelas
- **SSL**: Sempre usar conex√£o SSL em produ√ß√£o

## üíª Desenvolvimento

### Scripts Dispon√≠veis
```bash
npm run dev          # Desenvolvimento com hot-reload
npm run build        # Build para produ√ß√£o
npm run test         # Testes unit√°rios
npm run test:e2e     # Testes end-to-end
npm run lint         # Linting
npm run check:dry    # Verificar viola√ß√µes DRY
npm run check:quality # Verificar qualidade do c√≥digo
```

### Fluxo de Desenvolvimento
1. Criar branch: `git checkout -b feature/nome-feature`
2. Desenvolver seguindo padr√µes DDD/Clean
3. Escrever testes (m√≠nimo 80% cobertura)
4. Validar: `npm run lint && npm run test`
5. Commit: `git commit -m "feat(module): descri√ß√£o"`
6. Push e criar PR

## üì¶ M√≥dulos

### üîê M√≥dulo de Autentica√ß√£o (Auth)

#### Vis√£o Geral
Sistema de autentica√ß√£o 100% baseado em Supabase Cloud, sem banco de dados local. Todos os usu√°rios e sess√µes s√£o gerenciados diretamente no Supabase Auth.

#### ‚ö†Ô∏è IMPORTANTE: Arquitetura Cloud-Only
- **N√ÉO H√Å BANCO DE DADOS LOCAL**
- Todos os dados de usu√°rios est√£o no Supabase Cloud
- Autentica√ß√£o realizada diretamente com Supabase Auth
- User metadata armazenado no Supabase (nome, CPF, telefone, role, etc)
- Nenhuma tabela local de users ou sessions

#### Funcionalidades
- ‚úÖ **Cadastro de usu√°rios** direto no Supabase Auth
- ‚úÖ **Login** com email de alerta (IP, dispositivo, localiza√ß√£o)
- ‚úÖ **Email de notifica√ß√£o** em cada login bem-sucedido
- ‚úÖ **Two-Factor Authentication (2FA)** completo e funcional
  - Gera√ß√£o e envio de c√≥digo de 6 d√≠gitos por email
  - Valida√ß√£o com limite de 3 tentativas
  - Expira√ß√£o de c√≥digo em 5 minutos
  - Tabela `two_factor_codes` no Supabase Cloud
  - Integra√ß√£o 100% com Supabase Auth (sem banco local)
- ‚úÖ **Refresh token** para renova√ß√£o autom√°tica
- ‚úÖ **Sistema RBAC** com 11 roles hier√°rquicos
- ‚úÖ **Multi-tenant** com isolamento por tenant
- ‚úÖ **Guards de autoriza√ß√£o** (JWT, Roles, Tenant)
- ‚úÖ **Verifica√ß√£o de email** com tokens seguros e valida√ß√£o real
- ‚úÖ **Logs visuais** com links do Ethereal em desenvolvimento

#### Sistema de Roles (RBAC)
```typescript
// Roles Internos (Plataforma)
SUPER_ADMIN         // Acesso total
ADMIN_FINANCEIRO    // Gest√£o financeira
ADMIN_SUPORTE       // Customer success
ADMIN_EDITOR        // Marketing/conte√∫do
MARKETPLACE_MANAGER // Produtos/parceiros

// Roles Externos (Clientes)
CLINIC_OWNER        // Propriet√°rio da cl√≠nica
PROFESSIONAL        // Terapeuta
SECRETARY          // Secret√°ria
MANAGER            // Gestor sem especialidade
PATIENT            // Paciente
VISITOR            // Visitante n√£o autenticado
```

#### Endpoints da API

##### Autentica√ß√£o
```http
POST /auth/sign-in
Body: {
  email: string,
  password: string,
  rememberMe?: boolean
}
Response: {
  accessToken: string,      // JWT v√°lido por 15 minutos
  refreshToken: string,     // Token para renova√ß√£o
  expiresIn: 900,
  user: {
    id: string,
    email: string,
    name: string,
    role: string,
    tenantId: string | null
  }
}
Efeitos: 
  - Envia email de alerta com IP, dispositivo e localiza√ß√£o
  - Se 2FA ativo, retorna tempToken para valida√ß√£o

POST /auth/two-factor/send
Body: {
  tempToken: string,
  method?: 'email' | 'sms' | 'authenticator'
}
Response: {
  sentTo: string,           // Email/telefone mascarado
  method: string,
  expiresIn: 300,           // 5 minutos
  attemptsRemaining: number
}

POST /auth/two-factor/validate
Body: {
  tempToken: string,
  code: string,
  trustDevice?: boolean
}
Response: {
  accessToken: string,
  refreshToken: string,
  expiresIn: 900,
  user: { ... }
}

POST /auth/refresh
Body: {
  refreshToken: string
}
Response: {
  accessToken: string,
  refreshToken: string,
  expiresIn: 900
}

POST /auth/sign-out
Headers: Authorization: Bearer {token}
Body: {
  refreshToken?: string,
  allDevices?: boolean
}
Response: {
  success: true,
  message: string
}

GET /auth/me
Headers: Authorization: Bearer {token}
Response: {
  id: string,
  email: string,
  name: string,
  role: string,
  tenantId: string | null,
  emailVerified: boolean,
  twoFactorEnabled: boolean
}

GET /auth/verify-email?token={token}&email={email}
Response: {
  success: true,
  message: 'Email verificado com sucesso!'
}
```

#### Arquitetura do M√≥dulo Auth
```
modules/auth/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # Endpoints REST
‚îÇ   ‚îú‚îÄ‚îÄ dtos/              # DTOs com @ApiProperty
‚îÇ   ‚îî‚îÄ‚îÄ schemas/           # Schemas Zod para valida√ß√£o
‚îú‚îÄ‚îÄ use-cases/             # Casos de uso
‚îÇ   ‚îú‚îÄ‚îÄ sign-up.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ sign-in.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ validate-two-fa.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ refresh-token.use-case.ts
‚îÇ   ‚îî‚îÄ‚îÄ sign-out.use-case.ts
‚îú‚îÄ‚îÄ guards/                # Guards de seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îú‚îÄ‚îÄ roles.guard.ts
‚îÇ   ‚îî‚îÄ‚îÄ tenant.guard.ts
‚îú‚îÄ‚îÄ decorators/            # Decorators customizados
‚îÇ   ‚îú‚îÄ‚îÄ public.decorator.ts
‚îÇ   ‚îú‚îÄ‚îÄ roles.decorator.ts
‚îÇ   ‚îî‚îÄ‚îÄ current-user.decorator.ts
‚îî‚îÄ‚îÄ auth.module.ts         # M√≥dulo NestJS
```

#### Uso nos Controllers

##### Proteger rotas com autentica√ß√£o
```typescript
@Controller('patients')
@UseGuards(JwtAuthGuard) // Requer autentica√ß√£o
export class PatientsController {
  // Todos os endpoints requerem token JWT
}
```

##### Proteger com roles espec√≠ficas
```typescript
@Post('create')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(RolesEnum.CLINIC_OWNER, RolesEnum.PROFESSIONAL)
async createPatient() {
  // Apenas CLINIC_OWNER e PROFESSIONAL podem acessar
}
```

##### Rotas p√∫blicas
```typescript
@Get('public-info')
@Public() // N√£o requer autentica√ß√£o
async getPublicInfo() {
  // Endpoint p√∫blico
}
```

#### üìß Sistema de Emails

##### Configura√ß√£o
```env
# Desenvolvimento (Ethereal - emails de teste)
EMAIL_HOST=smtp.ethereal.email
EMAIL_PORT=587
EMAIL_USER=lina73@ethereal.email
EMAIL_PASS=bZdVJ4VJdP46V6w5jx
EMAIL_FROM=noreply@onterapi.com

# Produ√ß√£o (configurar seu SMTP)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=seu-email@gmail.com
EMAIL_PASS=sua-senha-app
EMAIL_FROM=noreply@onterapi.com
```

##### Emails Enviados pelo Sistema

###### 1. Email de Alerta de Login
- **Quando**: Sempre que um usu√°rio faz login
- **Conte√∫do**: IP, dispositivo, navegador, localiza√ß√£o, data/hora
- **Template**: HTML responsivo com informa√ß√µes detalhadas
- **Logs**: Link do Ethereal para visualiza√ß√£o em desenvolvimento

###### 2. Email de Verifica√ß√£o
- **Quando**: Novo cadastro de usu√°rio
- **Conte√∫do**: Link para verificar email
- **Validade**: 24 horas

###### 3. Email de C√≥digo 2FA
- **Quando**: Login com 2FA ativado
- **Conte√∫do**: C√≥digo de 6 d√≠gitos
- **Validade**: 5 minutos

###### 4. Email de Boas-Vindas
- **Quando**: Ap√≥s verifica√ß√£o do email
- **Conte√∫do**: Informa√ß√µes sobre a plataforma

#### üîÑ Fluxo de Autentica√ß√£o Completo

##### 1. Cadastro de Novo Usu√°rio
```mermaid
graph LR
    A[POST /users] --> B[Cria no Supabase Auth]
    B --> C[Salva metadata]
    C --> D[Envia email verifica√ß√£o]
    D --> E[Retorna user criado]
```

##### 2. Login Normal
```mermaid
graph LR
    A[POST /auth/sign-in] --> B[Valida no Supabase]
    B --> C{2FA ativo?}
    C -->|N√£o| D[Gera tokens JWT]
    C -->|Sim| E[Retorna tempToken]
    D --> F[Envia email alerta]
    F --> G[Retorna tokens + user]
    E --> H[Aguarda c√≥digo 2FA]
```

##### 3. Login com 2FA
```mermaid
graph LR
    A[POST /auth/two-factor/send] --> B[Gera c√≥digo 6 d√≠gitos]
    B --> C[Salva em two_factor_codes]
    C --> D[Envia por email]
    D --> E[POST /auth/two-factor/validate]
    E --> F[Valida c√≥digo no banco]
    F --> G[Gera tokens JWT]
    G --> H[Retorna tokens + user]
```

**Fluxo Detalhado do 2FA:**
1. Login detecta `twoFactorEnabled: true` no user_metadata
2. Retorna `requiresTwoFactor: true` com `tempToken`
3. Cliente envia tempToken para `/auth/two-factor/send`
4. Sistema gera c√≥digo de 6 d√≠gitos e salva no Supabase
5. Email enviado com c√≥digo (v√°lido por 5 minutos)
6. Cliente envia c√≥digo para `/auth/two-factor/validate`
7. Sistema valida c√≥digo e retorna tokens completos

#### üê≥ Configura√ß√£o Docker

##### docker-compose.yml
```yaml
services:
  app:
    build: .
    ports:
      - "3001:3000"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    extra_hosts:
      - "ogffdaemylaezxpunmop.supabase.co:104.18.38.10"
      - "aws-0-sa-east-1.pooler.supabase.com:54.94.90.106"
      - "smtp.ethereal.email:95.216.108.161"
    environment:
      NODE_OPTIONS: "--dns-result-order=ipv4first"
```

**Nota**: Os extra_hosts s√£o necess√°rios para resolver DNS dentro do container Docker.

##### Obter usu√°rio atual
```typescript
@Get('profile')
@UseGuards(JwtAuthGuard)
async getProfile(@CurrentUser() user: ICurrentUser) {
  // user cont√©m: id, email, name, role, tenantId
  return user;
}
```

### üë• M√≥dulo de Usu√°rios (Users)

#### Vis√£o Geral
CRUD completo de usu√°rios com permiss√µes granulares, integra√ß√£o com Supabase Auth e valida√ß√µes rigorosas.

#### Funcionalidades
- ‚úÖ **Create**: Cadastro p√∫blico ou via admin
- ‚úÖ **Read**: Busca por ID (pr√≥prio ou admin)
- ‚úÖ **Update**: Atualiza√ß√£o de dados (pr√≥prio ou admin)
- ‚úÖ **Delete**: Soft delete mantendo hist√≥rico
- ‚úÖ **List**: Listagem com filtros (apenas admin)
- ‚úÖ **Valida√ß√µes**: CPF √∫nico, email √∫nico, senha forte
- ‚úÖ **Integra√ß√£o Supabase**: Sincroniza√ß√£o autom√°tica
- ‚úÖ **Pagina√ß√£o**: Em todas as listagens
- ‚úÖ **Filtros**: Por role, tenant, status ativo

#### Permiss√µes dos Endpoints

| Endpoint | M√©todo | Descri√ß√£o | Permiss√£o | Status |
|----------|--------|-----------|-----------|---------|
| `/users` | POST | Criar usu√°rio | P√∫blico OU Admin | ‚úÖ Funcionando |
| `/users` | GET | Listar todos | SUPER_ADMIN, ADMIN_SUPORTE | ‚úÖ Funcionando |
| `/users/:id` | GET | Buscar por ID | Admin OU pr√≥prio usu√°rio | ‚ö†Ô∏è Retorna vazio |
| `/users/:id` | PATCH | Atualizar parcial | Admin OU pr√≥prio usu√°rio | ‚úÖ Funcionando |
| `/users/:id` | PUT | Atualizar completo | Admin OU pr√≥prio usu√°rio | ‚ùå N√£o implementado |
| `/users/:id` | DELETE | Deletar (soft) | SUPER_ADMIN | ‚úÖ Funcionando |

#### Endpoints da API

##### Criar Usu√°rio
```http
POST /users
Body: {
  email: string,
  password: string,  // M√≠nimo 8 chars, mai√∫scula, min√∫scula, n√∫mero, especial
  name: string,
  cpf: string,       // Apenas n√∫meros, validado
  phone?: string,    // Opcional, formato brasileiro
  role: RolesEnum,
  tenantId?: string  // UUID da cl√≠nica
}
```

##### Listar Usu√°rios (Admin Only)
```http
GET /users?page=1&limit=20&role=PATIENT&tenantId=uuid&isActive=true
Headers: Authorization: Bearer {admin_token}
```

##### Buscar Usu√°rio
```http
GET /users/:id
Headers: Authorization: Bearer {token}
```

##### Atualizar Usu√°rio
```http
PATCH /users/:id
Headers: Authorization: Bearer {token}
Body: {
  name?: string,
  phone?: string,
  isActive?: boolean,
  metadata?: object
}
```

##### Deletar Usu√°rio
```http
DELETE /users/:id
Headers: Authorization: Bearer {token}
```

#### Arquitetura do M√≥dulo Users
```
modules/users/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # Endpoints REST
‚îÇ   ‚îú‚îÄ‚îÄ dtos/              # DTOs com Swagger
‚îÇ   ‚îî‚îÄ‚îÄ schemas/           # Valida√ß√£o Zod
‚îú‚îÄ‚îÄ use-cases/
‚îÇ   ‚îú‚îÄ‚îÄ create-user.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ find-all-users.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ find-user-by-id.use-case.ts
‚îÇ   ‚îú‚îÄ‚îÄ update-user.use-case.ts
‚îÇ   ‚îî‚îÄ‚îÄ delete-user.use-case.ts
‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îî‚îÄ‚îÄ user-owner.guard.ts  # Verifica se √© admin ou dono
‚îî‚îÄ‚îÄ users.module.ts
```

#### Guards de Seguran√ßa

##### JwtAuthGuard
- Valida tokens JWT
- Extrai metadata do usu√°rio do Supabase
- **IMPORTANTE**: Corrigido em v0.5.1 para extrair corretamente o role do user_metadata

##### RolesGuard
- Verifica hierarquia de permiss√µes
- Funciona em conjunto com @Roles decorator

##### UserOwnerGuard
Guard especial que permite acesso se:
- Usu√°rio √© admin (SUPER_ADMIN, ADMIN_SUPORTE, ADMIN_FINANCEIRO)
- Usu√°rio est√° acessando seus pr√≥prios dados

```typescript
@Get(':id')
@UseGuards(JwtAuthGuard, UserOwnerGuard)
async findOne(@Param('id') id: string) {
  // Admin ou pr√≥prio usu√°rio podem acessar
}
```

#### Configura√ß√£o Necess√°ria

##### Vari√°veis de Ambiente
```env
# JWT Secrets
JWT_ACCESS_SECRET=your_access_secret_min_32_chars
JWT_REFRESH_SECRET=your_refresh_secret_min_32_chars
JWT_2FA_SECRET=your_2fa_secret_min_32_chars

# Supabase Auth (OBRIGAT√ìRIO)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# App Config
APP_URL=http://localhost:3000
APP_NAME=OnTerapi
```

##### Depend√™ncias Necess√°rias
```json
{
  "@supabase/supabase-js": "^2.x",
  "speakeasy": "^2.x",      // Para 2FA TOTP
  "qrcode": "^1.x",         // Para gerar QR Code
  "bcryptjs": "^2.x",       // Hash de senhas
  "@nestjs/jwt": "^10.x",   // JWT
  "@nestjs/passport": "^10.x"
}
```

### Outros M√≥dulos Principais
- **Patients**: Gest√£o de pacientes
- **Appointments**: Sistema de agendamento
- **Anamnesis**: Anamnese digital
- **Consultations**: Gest√£o de consultas
- **TherapeuticPlans**: Planos com IA
- **Financial**: Pagamentos e split
- **Clinics**: Gest√£o multi-cl√≠nica
- **CrewAI**: Integra√ß√£o com 23 agentes

## üìä API Documentation

### Swagger
Dispon√≠vel em desenvolvimento: `http://localhost:3001/api`

### Endpoints Principais
- `POST /auth/login` - Autentica√ß√£o
- `GET /patients` - Listar pacientes
- `POST /appointments` - Criar agendamento
- `GET /anamnesis/:id` - Buscar anamnese
- `POST /therapeutic-plans` - Gerar plano com IA

## üß™ Testes

### Executar Testes
```bash
npm run test         # Unit√°rios
npm run test:watch   # Watch mode
npm run test:cov     # Coverage
npm run test:e2e     # End-to-end
```

### Cobertura M√≠nima
- Unit√°rios: 80%
- Integra√ß√£o: 70%
- E2E: Fluxos cr√≠ticos

## üê≥ Docker

### Configura√ß√£o Docker
O projeto est√° totalmente containerizado para facilitar desenvolvimento e deploy.

#### Docker Compose
```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: onterapi-app
    ports:
      - "3001:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NODE_OPTIONS: "--dns-result-order=ipv4first"
    env_file:
      - .env
    volumes:
      - ./src:/app/src:delegated
      - ./logs:/app/logs
    depends_on:
      - redis
    networks:
      - onterapi-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: onterapi-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-onterapi_redis_2024}
    volumes:
      - redis-data:/data
    networks:
      - onterapi-network
    restart: unless-stopped

volumes:
  redis-data:

networks:
  onterapi-network:
    driver: bridge
```

#### Comandos Docker
```bash
# Build da imagem
docker build -t onterapi-v4:latest .

# Iniciar com Docker Compose
docker compose up -d

# Ver logs
docker compose logs -f

# Parar servi√ßos
docker compose stop

# Remover tudo
docker compose down -v

# Executar comandos no container
docker compose exec app npm run migration:run
docker compose exec app npm test
```

### Troubleshooting Docker

#### Erro IPv6
Se encontrar erro `Error: connect ENETUNREACH 2600:...`, use o Supabase Pooler:
```env
# Use Pooler para IPv4
DB_HOST=aws-0-sa-east-1.pooler.supabase.com
DB_PORT=6543
DB_USERNAME=postgres.ogffdaemylaezxpunmop
NODE_OPTIONS=--dns-result-order=ipv4first
```

## üîÑ CI/CD

### Pipeline
1. **Lint & Format**: Valida√ß√£o de c√≥digo
2. **Tests**: Unit√°rios e integra√ß√£o
3. **Build**: Compila√ß√£o TypeScript
4. **Security**: Scan de vulnerabilidades
5. **Deploy**: Staging ‚Üí Production

## üìù Changelog

Veja [CHANGELOG.md](./CHANGELOG.md) para hist√≥rico de mudan√ßas.

## üìÑ Licen√ßa

Proprietary - OnTerapi ¬© 2024. Todos os direitos reservados.

## ü§ù Contribuindo

1. Siga os padr√µes definidos em `.claude/agent-onterapi.md`
2. Use commits sem√¢nticos
3. Mantenha cobertura de testes
4. Atualize documenta√ß√£o

## üìû Suporte

- Email: dev@onterapi.com.br
- Docs: https://docs.onterapi.com.br

---

*OnTerapi v4 - Desenvolvido com princ√≠pios DDD e Clean Architecture*